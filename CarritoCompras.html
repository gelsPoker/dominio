<!DOCTYPE html>
<html lang="es">
<head>
  <title>Carrito de Compras â€“ VeggiGo</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>
  <!-- Navbar mÃ­nima -->
  <nav class="navbar navbar-expand-sm navbar-dark bg-success">
    <div class="container-fluid">
      <a class="navbar-brand" href="ComidaVegana.html">VeggiGo</a>
      <div class="ms-auto d-flex align-items-center gap-3">
        <a href="productos.html" class="btn btn-outline-light">Seguir comprando</a>
        <a href="CarritoCompras.html" class="btn btn-outline-light position-relative">
          ðŸ›’ <span id="cartCountBadge" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">0</span>
        </a>
      </div>
    </div>
  </nav>

  <main class="container py-4">
    <h1 class="h3 mb-4">Tu carrito</h1>

    <div id="emptyState" class="alert alert-light border d-none">
      Tu carrito estÃ¡ vacÃ­o. <a href="productos.html" class="alert-link">Explorar productos</a>
    </div>

    <div id="cartWrap" class="card">
      <div class="table-responsive">
        <table class="table align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th style="width:50%">Producto</th>
              <th>Precio</th>
              <th style="width:180px">Cantidad</th>
              <th>Subtotal</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="cartTableBody"><!-- render JS --></tbody>
        </table>
      </div>
      <div class="card-body d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-3">
        <button id="btnVaciar" class="btn btn-outline-danger">Vaciar carrito</button>
        <div class="ms-md-auto">
          <div class="fs-5">Total: <strong id="cartTotal">$0</strong></div>
          <button class="btn btn-success w-100 mt-2" disabled>Ir a pagar</button>
          <div class="small text-muted mt-1">* Demo sin backend</div>
        </div>
      </div>
    </div>
  </main>

  <!-- Script base (mismo que en las otras pÃ¡ginas) -->
  <script>
    // --- Carrito compartido (localStorage) ---
    const CART_KEY = 'veggigo_cart_v1';

    function getCart(){ try { return JSON.parse(localStorage.getItem(CART_KEY) || '[]'); } catch { return []; } }
    function saveCart(cart){ localStorage.setItem(CART_KEY, JSON.stringify(cart)); }

    function addToCart(product, qty=1){
    const cart = getCart();
    const i = cart.findIndex(p => p.id === product.id);
    if (i > -1) cart[i].qty += qty;
    else cart.push({ ...product, qty });
    saveCart(cart);
    }
  (function () {
    const CART_KEY = 'veggigo_cart_v1';
    const $badge = document.getElementById('cartCountBadge');
    function currency(n){ try{ return new Intl.NumberFormat('es-CL',{style:'currency',currency:'CLP',maximumFractionDigits:0}).format(n);}catch{ return '$'+n; } }
    function getCart(){ return JSON.parse(localStorage.getItem(CART_KEY)||'[]'); }
    function saveCart(c){ localStorage.setItem(CART_KEY, JSON.stringify(c)); updateBadge(); renderTable(); }
    function updateBadge(){ if(!$badge) return; const count=getCart().reduce((s,i)=>s+i.qty,0); $badge.textContent=count; $badge.style.display=count? '':'none'; }

    const $tbody = document.getElementById('cartTableBody');
    const $total = document.getElementById('cartTotal');
    const $wrap  = document.getElementById('cartWrap');
    const $empty = document.getElementById('emptyState');

    function renderTable(){
      const cart = getCart();
      if (!cart.length) {
        $wrap.classList.add('d-none');
        $empty.classList.remove('d-none');
        return;
      }
      $wrap.classList.remove('d-none');
      $empty.classList.add('d-none');

      $tbody.innerHTML = '';
      let total = 0;

      cart.forEach(item => {
        const sub = item.price * item.qty;
        total += sub;

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>
            <div class="d-flex align-items-center gap-3">
              <img src="${item.image || 'https://via.placeholder.com/72'}" alt="${item.name}"
                   width="72" height="72" class="rounded" style="object-fit:cover">
              <div>
                <div class="fw-semibold">${item.name}</div>
                <div class="text-muted small">ID: ${item.id}</div>
              </div>
            </div>
          </td>
          <td>${currency(item.price)}</td>
          <td>
            <div class="btn-group" role="group" aria-label="qty">
              <button class="btn btn-outline-secondary" data-dec="${item.id}">-</button>
              <span class="btn btn-outline-secondary disabled">${item.qty}</span>
              <button class="btn btn-outline-secondary" data-inc="${item.id}">+</button>
            </div>
          </td>
          <td>${currency(sub)}</td>
          <td class="text-end">
            <button class="btn btn-outline-danger btn-sm" data-remove="${item.id}">Eliminar</button>
          </td>`;
        $tbody.appendChild(tr);
      });

      $total.textContent = currency(total);
    }

    document.addEventListener('click', (ev) => {
      const t = ev.target;

      if (t.matches('[data-inc]')) {
        const id = t.getAttribute('data-inc');
        const cart = getCart();
        const it = cart.find(i => i.id === id);
        if (it) { it.qty++; saveCart(cart); }
      }

      if (t.matches('[data-dec]')) {
        const id = t.getAttribute('data-dec');
        const cart = getCart();
        const it = cart.find(i => i.id === id);
        if (it) { it.qty = Math.max(1, it.qty - 1); saveCart(cart); }
      }

      if (t.matches('[data-remove]')) {
        const id = t.getAttribute('data-remove');
        let cart = getCart().filter(i => i.id !== id);
        saveCart(cart);
      }

      if (t.id === 'btnVaciar') {
        localStorage.setItem(CART_KEY, '[]');
        updateBadge();
        renderTable();
      }
    });

    // Inicio
    updateBadge();
    renderTable();
  })();
  </script>
</body>
</html>